---
kind: pipeline
type: docker
name: backend

volumes:
- name: docker
  host:
    path: /var/run/docker.sock

steps:
  - name: docker
    image: plugins/docker
    volumes:
    - name: docker
      path: /var/run/docker.sock
    settings:
      repo: ccr.ccs.tencentyun.com/franktrue/fupanhezi-admin-api
      registry: ccr.ccs.tencentyun.com
      password: 
        from_secret: tencent_tcr_password
      username: 
        from_secret: tencent_id
      dockerfile: docker_env/django/Dockerfile
      tags:
      - latest
      dry_run: false

  - name: publish-celery
    image: plugins/docker
    volumes:
    - name: docker
      path: /var/run/docker.sock
    settings:
      repo: ccr.ccs.tencentyun.com/franktrue/fupanhezi-admin-celery
      registry: ccr.ccs.tencentyun.com
      password: 
        from_secret: tencent_tcr_password
      username: 
        from_secret: tencent_id
      dockerfile: docker_env/celery/Dockerfile
      tags:
      - latest
      dry_run: false

trigger:
  path:
    include:
      - backend/**
  event:
    - push
    - pull_request
  branch:
    - main
  
---
kind: pipeline
type: docker
name: frontend

volumes:
- name: docker
  host:
    path: /var/run/docker.sock

steps:
  - name: publish-web
    image: plugins/docker
    volumes:
    - name: docker
      path: /var/run/docker.sock
    settings:
      repo: ccr.ccs.tencentyun.com/franktrue/fupanhezi-admin-web
      registry: ccr.ccs.tencentyun.com
      password: 
        from_secret: tencent_tcr_password
      username: 
        from_secret: tencent_id
      dockerfile: docker_env/web/Dockerfile
      tags:
      - latest
      dry_run: false

trigger:
  path:
    include:
      - web/**
  event:
    - push
    - pull_request
  branch:
    - main

---
kind: pipeline
type: docker
name: deploy
depends_on: ["backend", "frontend"]

steps:
  - name: sync-file
    image: drillster/drone-rsync
    settings:
      user: root
      key:
        from_secret: ssh_key
      hosts: # 多个ip使用,隔开
        from_secret: ssh_host
      # 来源目录
      source: docker_env/deploy
      # 目标服务器目录
      target: /mnt/data/wwwroot/fupanhezi/admin
      script:
        - cd /mnt/data/wwwroot/fupanhezi/admin
        - docker-compose restart
        - echo "Deploy Success"
